apiVersion: workload.matrixinfer.ai/v1alpha1
kind: modelinfer
metadata:
  labels:
    model.uid: randomUID
  name: ds-r1-qwen-7b-pd-0-vllmdisaggregated-instance
  namespace: demo
  ownerReferences:
    - apiVersion: registry.matrixinfer.ai/v1alpha1
      kind: Model
      name: ds-r1-qwen-7b-pd
      uid: randomUID
spec:
  recoveryPolicy: InferGroupRestart
  replicas: 1
  rolloutStrategy:
    type: InferGroupRollingUpdate
  schedulerName: volcano
  template:
    gangSchedule: {}
    restartGracePeriodSeconds: 60
    roles:
      - entryTemplate:
          spec:
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: volcano.sh/hypernode
                          operator: In
                          values:
                            - 78533445-4b1f-11f0-a3ab-0255ac10007d
            containers:
              - args:
                  - --port
                  - "8100"
                  - --engine
                  - vllm
                  - --url
                  - http://localhost:8000/metrics
                image: matrixinfer/runtime:latest
                name: runtime
                ports:
                  - containerPort: 8100
                resources: {}
              - command:
                  - python
                  - -m
                  - vllm.entrypoints.openai.api_server
                  - --model
                  - /cache/568a486051fd302c338d84946c4f3d48
                  - --served-model-name
                  - ds-r1-qwen-7b-pd
                  - --tensor-parallel-size
                  - "16"
                  - --gpu-memory-utilization
                  - "0.95"
                  - --disable-frontend-multiprocessing
                  - --max-model-len
                  - "1024"
                  - --trust-remote-code
                  - --quantization
                  - ascend
                  - --kv-transfer-config
                  - '{"kv_rank":0, "kv_connector":"AscendSimpleConnector","kv_buffer_device":"npu","kv_role":"kv_producer",
              "kv_parallel_size":2,"kv_connector_extra_config":{"prefill_device_ips":
              ["214.71.150.137", "214.71.173.73", "214.71.230.168", "214.71.161.230",
              "214.71.128.255", "214.71.130.82", "214.71.160.69", "214.71.189.91",
              "214.71.251.142", "214.71.149.222", "214.71.245.25", "214.71.153.236",
              "214.71.148.108", "214.71.154.164", "214.71.234.231", "214.71.167.204"],"decode_device_ips":
              ["214.71.227.226", "214.71.186.209", "214.71.208.127", "214.71.196.104",
              "214.71.128.44", "214.71.174.225", "214.71.221.13", "214.71.225.152",
              "214.71.151.147", "214.71.200.47", "214.71.239.51", "214.71.203.53",
              "214.71.190.45", "214.71.145.113", "214.71.166.79", "214.71.142.27"]}}'
                env:
                  - name: HF_HUB_OFFLINE
                    value: "1"
                  - name: HCCL_IF_IP
                    valueFrom:
                      fieldRef:
                        fieldPath: status.podIP
                  - name: GLOO_SOCKET_IFNAME
                    value: eth0
                  - name: TP_SOCKET_IFNAME
                    value: eth0
                  - name: HCCL_SOCKET_IFNAME
                    value: eth0
                image: vllm-prefill:latest
                imagePullPolicy: IfNotPresent
                livenessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 900
                  periodSeconds: 5
                name: vllm
                ports:
                  - containerPort: 8000
                readinessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 5
                  periodSeconds: 5
                resources:
                  requests:
                    cpu: 100m
                    huawei.com/ascend-1980: "1"
                    memory: 1Gi
                volumeMounts:
                  - mountPath: /cache/568a486051fd302c338d84946c4f3d48
                    name: models
                    readOnly: true
            initContainers:
              - args:
                  - --source
                  - s3://aios_models/deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
                  - --output-dir
                  - /cache/568a486051fd302c338d84946c4f3d48
                envFrom:
                  - secretRef:
                      name: downloader-secrets
                image: matrixinfer/downloader:latest
                imagePullPolicy: Always
                name: downloader
                resources: {}
                volumeMounts:
                  - mountPath: /cache/568a486051fd302c338d84946c4f3d48
                    name: models
            volumes:
              - hostPath:
                  path: /cache/568a486051fd302c338d84946c4f3d48
                  type: DirectoryOrCreate
                name: models
        name: prefill
        replicas: 1
        workerReplicas: 0
        workerTemplate:
          spec:
            containers: []
      - entryTemplate:
          spec:
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: volcano.sh/hypernode
                          operator: In
                          values:
                            - f0189bcc-1479-11f0-8512-0255ac100079
            containers:
              - args:
                  - --port
                  - "8100"
                  - --engine
                  - vllm
                  - --url
                  - http://localhost:8000/metrics
                image: matrixinfer/runtime:latest
                name: runtime
                ports:
                  - containerPort: 8100
                resources: {}
              - command:
                  - python
                  - -m
                  - vllm.entrypoints.openai.api_server
                  - --model
                  - /cache/568a486051fd302c338d84946c4f3d48
                  - --served-model-name
                  - ds-r1-qwen-7b-pd
                  - --tensor-parallel-size
                  - "16"
                  - --gpu-memory-utilization
                  - "0.95"
                  - --disable-frontend-multiprocessing
                  - --max-model-len
                  - "1024"
                  - --trust-remote-code
                  - --quantization
                  - ascend
                  - --kv-transfer-config
                  - '{"kv_rank":1, "kv_connector":"AscendSimpleConnector","kv_buffer_device":"npu","kv_role":"kv_consumer",
              "kv_parallel_size":2,"kv_connector_extra_config":{"prefill_device_ips":
              ["214.71.150.137", "214.71.173.73", "214.71.230.168", "214.71.161.230",
              "214.71.128.255", "214.71.130.82", "214.71.160.69", "214.71.189.91",
              "214.71.251.142", "214.71.149.222", "214.71.245.25", "214.71.153.236",
              "214.71.148.108", "214.71.154.164", "214.71.234.231", "214.71.167.204"],"decode_device_ips":
              ["214.71.227.226", "214.71.186.209", "214.71.208.127", "214.71.196.104",
              "214.71.128.44", "214.71.174.225", "214.71.221.13", "214.71.225.152",
              "214.71.151.147", "214.71.200.47", "214.71.239.51", "214.71.203.53",
              "214.71.190.45", "214.71.145.113", "214.71.166.79", "214.71.142.27"]}}'
                env:
                  - name: HF_HUB_OFFLINE
                    value: "1"
                  - name: GLOO_SOCKET_IFNAME
                    value: eth0
                  - name: TP_SOCKET_IFNAME
                    value: eth0
                  - name: HCCL_SOCKET_IFNAME
                    value: eth0
                image: vllm-decode:latest
                imagePullPolicy: IfNotPresent
                livenessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 900
                  periodSeconds: 5
                name: vllm
                ports:
                  - containerPort: 8000
                readinessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 5
                  periodSeconds: 5
                resources:
                  requests:
                    cpu: 100m
                    huawei.com/ascend-1980: "1"
                    memory: 1Gi
                volumeMounts:
                  - mountPath: /cache/568a486051fd302c338d84946c4f3d48
                    name: models
                    readOnly: true
            initContainers:
              - args:
                  - --source
                  - s3://aios_models/deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
                  - --output-dir
                  - /cache/568a486051fd302c338d84946c4f3d48
                envFrom:
                  - secretRef:
                      name: downloader-secrets
                image: matrixinfer/downloader:latest
                imagePullPolicy: Always
                name: downloader
                resources: {}
                volumeMounts:
                  - mountPath: /cache/568a486051fd302c338d84946c4f3d48
                    name: models
            volumes:
              - hostPath:
                  path: /cache/568a486051fd302c338d84946c4f3d48
                  type: DirectoryOrCreate
                name: models
        name: decode
        replicas: 1
        workerReplicas: 0
        workerTemplate:
          spec:
            containers: []
status:
  availableReplicas: 0
