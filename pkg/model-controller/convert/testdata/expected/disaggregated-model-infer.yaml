apiVersion: workload.matrixinfer.ai/v1alpha1
kind: modelinfer
metadata:
  labels:
    registry.matrixinfer.ai/backend-name: ds-r1-qwen-7b-pd
    registry.matrixinfer.ai/managed-by: registry.matrixinfer.ai
    registry.matrixinfer.ai/model-name: ds-r1-qwen-7b-pd
    registry.matrixinfer.ai/model-uid: randomUID
    registry.matrixinfer.ai/revision: 994b886f8
  name: ds-r1-qwen-7b-pd-ds-r1-qwen-7b-pd
  namespace: demo
  ownerReferences:
    - apiVersion: registry.matrixinfer.ai/v1alpha1
      kind: Model
      name: ds-r1-qwen-7b-pd
      uid: randomUID
spec:
  recoveryPolicy: InferGroupRestart
  replicas: 1
  rolloutStrategy:
    type: InferGroupRollingUpdate
  schedulerName: volcano
  template:
    gangSchedule: {}
    restartGracePeriodSeconds: 60
    roles:
      - entryTemplate:
          spec:
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: node.kubernetes.io/npu.chip.name
                          operator: In
                          values:
                            - Ascend910
            containers:
              - args:
                  - --port
                  - "8100"
                  - --engine
                  - vllmdisaggregated
                  - --engine-base-url
                  - http://localhost:8000
                  - --engine-metrics-path
                  - /metrics
                  - --pod
                  - $(POD_NAME).$(NAMESPACE)
                  - --model
                  - ds-r1-qwen-7b-pd
                image: matrixinfer/runtime:latest
                name: runtime
                ports:
                  - containerPort: 8100
                resources: {}
              - command:
                  - python
                  - -m
                  - vllm.entrypoints.openai.api_server
                  - --model
                  - /cache/568a486051fd302c338d84946c4f3d48
                  - --enable-lora
                  - --disable-frontend-multiprocessing
                  - --gpu-memory-utilization
                  - "0.99"
                  - --max-model-len
                  - "2048"
                  - --quantization
                  - ascend
                  - --served-model-name
                  - ds-r1-qwen-7b-pd
                  - --tensor-parallel-size
                  - "16"
                  - --trust-remote-code
                  - --kv-events-config
                  - '{"enable_kv_cache_events":true,"publisher":"zmq","topic":"kv-events","endpoint":"tcp://*:5557"}'
                  - --enforce-eager
                env:
                  - name: ENDPOINT
                    value: https://obs.test.com
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: VLLM_USE_V1
                    value: "1"
                  - name: HF_HUB_OFFLINE
                    value: "1"
                  - name: HCCL_IF_IP
                    valueFrom:
                      fieldRef:
                        fieldPath: status.podIP
                image: vllm-prefill:latest
                imagePullPolicy: IfNotPresent
                livenessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 90
                  periodSeconds: 5
                name: vllm
                ports:
                  - containerPort: 8000
                readinessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 5
                  periodSeconds: 5
                resources:
                  limits:
                    cpu: "16"
                    huawei.com/ascend-1980: "1"
                    memory: 1Gi
                  requests:
                    cpu: "16"
                    huawei.com/ascend-1980: "1"
                    memory: 1Gi
                volumeMounts:
                  - mountPath: /cache
                    name: ds-r1-qwen-7b-pd-weights
            initContainers:
              - args:
                  - --source
                  - s3://aios_models/deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
                  - --output-dir
                  - /cache/568a486051fd302c338d84946c4f3d48
                env:
                  - name: ENDPOINT
                    value: https://obs.test.com
                envFrom:
                  - secretRef:
                      name: downloader-secrets
                image: matrixinfer/downloader:latest
                name: ds-r1-qwen-7b-pd-model-downloader
                resources: {}
                volumeMounts:
                  - mountPath: /cache
                    name: ds-r1-qwen-7b-pd-weights
            volumes:
              - hostPath:
                  path: /cache
                  type: DirectoryOrCreate
                name: ds-r1-qwen-7b-pd-weights
        name: prefill
        replicas: 1
        workerReplicas: 0
        workerTemplate:
          spec:
            containers: []
      - entryTemplate:
          spec:
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: node.kubernetes.io/npu.chip.name
                          operator: In
                          values:
                            - Ascend910
            containers:
              - args:
                  - --port
                  - "8100"
                  - --engine
                  - vllmdisaggregated
                  - --engine-base-url
                  - http://localhost:8000
                  - --engine-metrics-path
                  - /metrics
                  - --pod
                  - $(POD_NAME).$(NAMESPACE)
                  - --model
                  - ds-r1-qwen-7b-pd
                envFrom:
                - secretRef:
                    name: downloader-secrets
                image: matrixinfer/runtime:latest
                name: runtime
                ports:
                  - containerPort: 8100
                resources: {}
              - command:
                  - python
                  - -m
                  - vllm.entrypoints.openai.api_server
                  - --model
                  - /cache/568a486051fd302c338d84946c4f3d48
                  - --enable-lora
                  - --disable-frontend-multiprocessing
                  - --gpu-memory-utilization
                  - "0.95"
                  - --max-model-len
                  - "1024"
                  - --quantization
                  - ascend
                  - --served-model-name
                  - ds-r1-qwen-7b-pd
                  - --tensor-parallel-size
                  - "16"
                  - --trust-remote-code
                  - --kv-events-config
                  - '{"enable_kv_cache_events":true,"publisher":"zmq","topic":"kv-events","endpoint":"tcp://*:5557"}'
                  - --enforce-eager
                env:
                  - name: ENDPOINT
                    value: https://obs.test.com
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: VLLM_USE_V1
                    value: "1"
                  - name: HF_HUB_OFFLINE
                    value: "1"
                  - name: GLOO_SOCKET_IFNAME
                    value: eth0
                  - name: TP_SOCKET_IFNAME
                    value: eth0
                  - name: HCCL_SOCKET_IFNAME
                    value: eth0
                image: vllm-decode:latest
                imagePullPolicy: IfNotPresent
                livenessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 90
                  periodSeconds: 5
                name: vllm
                ports:
                  - containerPort: 8000
                readinessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: /health
                    port: 8000
                  initialDelaySeconds: 5
                  periodSeconds: 5
                resources:
                  limits:
                    cpu: "16"
                    huawei.com/ascend-1980: "1"
                    memory: 1Gi
                  requests:
                    cpu: "16"
                    huawei.com/ascend-1980: "1"
                    memory: 1Gi
                volumeMounts:
                  - mountPath: /cache
                    name: ds-r1-qwen-7b-pd-weights
            initContainers:
              - args:
                  - --source
                  - s3://aios_models/deepseek-ai/DeepSeek-R1-Distill-Qwen-7B
                  - --output-dir
                  - /cache/568a486051fd302c338d84946c4f3d48
                env:
                  - name: ENDPOINT
                    value: https://obs.test.com
                envFrom:
                  - secretRef:
                      name: downloader-secrets
                image: matrixinfer/downloader:latest
                name: ds-r1-qwen-7b-pd-model-downloader
                resources: { }
                volumeMounts:
                  - mountPath: /cache
                    name: ds-r1-qwen-7b-pd-weights
            volumes:
              - hostPath:
                  path: /cache
                  type: DirectoryOrCreate
                name: ds-r1-qwen-7b-pd-weights
        name: decode
        replicas: 1
        workerReplicas: 0
        workerTemplate:
          spec:
            containers: []
status:
  availableReplicas: 0
